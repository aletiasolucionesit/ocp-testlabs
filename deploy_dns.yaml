- name: Deploy DNS machine
  hosts: dns.essi.labs
  remote_user: root

  tasks:
    - name: Register and subscribe
      redhat_subscription:
        username: "{{ rh_user }}"
        auto_attach: yes
        password: "{{ rh_pass }}"
        state: present
      when:
        - ansible_distribution == "RedHat"
        - ( rh_user is defined and rh_pass is defined)

    - name: Install {{ item }}
      yum:
        name: "{{ item }}"
        state: latest
      loop:
        - dnsmasq
        - firewalld

    - name: Configure dnsmasq main file
      copy:
        dest: /etc/dnsmasq.conf
        content: |
          local=/essi.labs/
          address=/apps.essi.labs/192.168.131.10
          srv-host=_etcd-server-ssl._tcp.essi.labs,master.essi.labs,2380,0,10
          no-hosts
          addn-hosts=/etc/dnsmasq.openshift.addnhosts
          conf-dir=/etc/dnsmasq.d,.rpmnew,.rpmsave,.rpmorig

    - name: Configure dnsmasq OCP file
      copy:
        dest: /etc/dnsmasq.openshift.addnhosts
        content: |
          192.168.130.10 dns.essi.labs
          192.168.131.10 loadbalancer.essi.labs  api.essi.labs  api-int.essi.labs
          192.168.131.11 bootstrap.essi.labs
          192.168.131.12 master.essi.labs  etcd-0.essi.labs
          192.168.131.13 worker-1.essi.labs
          192.168.131.20 www.essi.labs

    - name: Start and enable {{ item }}
      systemd:
        name: "{{ item }}"
        enabled: true 
        state: started
      loop:
        - dnsmasq
        - firewalld

    - name: Create dnsmasq firewall rule
      firewalld:
        state: enabled
        service: dns
        immediate: true
        permanent: true
