- name: Prepare openshift-install
  hosts: www.{{ clusterName }}.{{ baseDomain }}
  gather_facts: false
  remote_user: root
  vars_files:
    - vars/default.yaml

  tasks:
    - name: get release
      uri:
        url: "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest-{{ ocp_release }}/release.txt"
        return_content: true
      register: release

    - name: set version
      set_fact:
        version: "{{ release.content|regex_search('(Name:.*)')|regex_replace('Name:')|trim() }}"

    - name: Create "{{ ocp_install_dir }}"
      file:
        path: "{{ ocp_install_dir }}"
        state: directory

    - name: Download installer
      unarchive:
        src: "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest-{{ ocp_release }}/openshift-install-linux-{{ version }}.tar.gz"
        dest: "{{ ocp_install_dir }}"
        remote_src: true

    - name: Download openshift-client
      unarchive:
        src: "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest-{{ ocp_release }}/openshift-client-linux-{{ version }}.tar.gz"
        dest: /usr/local/bin/
        remote_src: true

    - name: Copy instructions
      copy:
        src: files/Instructions.md
        dest: "{{ ocp_install_dir }}/Instructions.md"

    - name: Create install-config.yaml
      copy:
        dest: "{{ ocp_install_dir }}/install-config.yaml"
        content: |
          apiVersion: v1
          baseDomain: {{ baseDomain }}
          compute:
          - hyperthreading: Enabled
            name: worker
            platform: {}
            replicas: 0
          controlPlane:
            hyperthreading: Enabled
            name: master
            platform: {}
            replicas: 3
          metadata:
            creationTimestamp: null
            name: {{ clusterName }}
          networking:
            clusterNetwork:
            - cidr: 10.128.0.0/14
              hostPrefix: 23
            networkType: OpenShiftSDN
            serviceNetwork:
            - 172.30.0.0/16
          platform:
            none: {}
          pullSecret: '{{ lookup('file', pull_secret_path) }}'
          sshKey: '{{ lookup('file', ssh_key_path) }}'

